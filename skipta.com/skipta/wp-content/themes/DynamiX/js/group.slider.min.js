
	(function( $ ) {

		"use strict";

			var acodaGroupAjaxLoadData = function( container, opts, offset )
			{
				var type			= $( container ).attr('data-type'), 
					source 			= $( container ).attr('data-source'),
					query 			= $( container ).attr('data-query'),
					ajax_url 		= $( container ).attr('data-ajaxurl'),
					grid_columns 	= $( container ).attr('data-grid-columns'),
					attributes 	= $( container ).attr('data-attributes'),	
					data_offset 	= offset,	
					load_value 	= $( container + ' .dynamic-frame').attr('data-load-value'),
					total 			= $( container + ' .dynamic-frame').attr('data-total'),
					data 			= '';				
					
					$( container ).attr('data-query', 'loading');
					
					$.ajax({
						  url: ajax_url,
						  type:'POST',
						  data:{
								action			: 'acoda_ajaxdata',
								query			: query,
								type			: type,
								source			: source,
								data_offset	: data_offset,
								load_value		: load_value,
								attributes		: attributes,
								grid_columns	: grid_columns
						  },
						  success:function(data)
						  {							
								if( data != '' && data_offset < total )
								{
									opts.addSlide( data );
									$( container ).attr('data-query', query );
								}
						  }	  
					});		
			}
			
			function resize_container( gallery, state )
			{
	
				var width	= $( gallery + ' .groupslides-wrap').width(),
					height	= $( gallery + ' .groupslides-wrap.current').height();
					
				if( height > 1 )
				{
					if( state == 'load' )
					{
						$( gallery +' .group-slider').css(
						{
							//height: height,
							width: width
						});	
					}
					else
					{
						$( gallery +' .group-slider').animate(
						{
							height: height,
							width: width
						}, 750, function() {
							// Animation complete.
						});						
					}
				}
			}		
		


			/* :: 	Group Slider							      
			---------------------------------------------*/	
				
			var group_gallery = function() {

				$('.gallery-wrap.group-slider').each(function(index, value) { 	
						
					var gallery = '#'+$(this).attr('id'),
						effect = $( gallery ).attr("data-groupslider-fx"),
						timeout = $( gallery + ' .timeout').val()*1000;

					// Cycle through iframe(s) > retrieve src and create data-src. 
					$( gallery +' iframe').each(function(index, value) { 
						var src = $(this).attr('src');
						$(this).attr('data-src',src);		
					});							
			
					$( gallery + ' .group-slider').cycle({ 
						fx: effect,
						timeout: timeout,
						speed: 500,
						slideResize: 0,		
						slideExpr: '.groupslides-wrap',			
						cleartype:  true,
						cleartypeNoBg:  true,
						before:  onBefore,
						after:  onAfter,
						prev: gallery + ' .slidernav-left',
						next: gallery + ' .slidernav-right'
					});
								
					$( gallery ).touchwipe({
						preventDefaultEvents: false,
							wipeLeft: function() {
								$( gallery + ' .group-slider').cycle('next');
								return false;
							},
							wipeRight: function() {
								$( gallery + ' .group-slider').cycle("prev");
								return false;
							}
					});	
	
	
					$(window).resize(function()
					{
						resize_container( gallery );	
					});	
							
		
					function onBefore()
					{ 		
						$( gallery + ' .group-slider .groupslides-wrap.current').removeClass('current');
						$(this).addClass('current');	
	
						if( ! $( gallery ).hasClass('loading' ) )
						{
							$(this).find('.panel').removeClass('active').removeClass('init');
							
							$( this ).find('.panel').each(function(i)
							{
								var column = $(this);
								setTimeout(function() {
									column.addClass('active');
								}, 50*i);				
							});		
						}
						else
						{
							$(this).find('.panel').addClass('init');
						}
						
						resize_container( gallery );								
					}
		
		
					function onAfter(currElement, nextElement, opts, isForward) {

						// iFrame					
						$( gallery +' iframe').attr('src', '');
							
						$(this).find('iframe').each(function(index, value) { 
							// Apply data-src to iframe src attribute
							var data_src = $(this).attr('data-src');

							if( data_src )
							{						
								console.log('data_src:before', data_src);
								$(this).attr('src', data_src);
							}
						});

						// Captions
						var caption_timeout = parseInt( timeout - 2000);
											

						var videoid = $(this).find('.jwplayer').attr("id");						
								
						$( gallery + ' .panel .jwplayer').each(function(index)
						{
							var obj = '';
							obj = $(this).attr("id");

							if( jwplayer(obj).getState() == 'PLAYING' )
							{
								jwplayer(obj).pause();
							}

							if( obj == videoid && ( $(this).hasClass("autostart") || $(this).parent('.jwplayer-wrapper').hasClass("autostart") ) )
							{
								if( jwplayer(obj).getState() == "IDLE" || jwplayer(obj).getState() == "PAUSED" )
								{
									jwplayer(obj).play();
								}
							}					 
						});

			 	 		var	slides_total = $( gallery + ' .dynamic-frame').attr('data-total'),
				 			items = $( gallery ).find('.panel').length;	
						

						if( $( gallery ).attr('data-load-method') == 'auto_load' && items < slides_total && $( gallery ).attr('data-query') != 'loading' )
						{
							acodaGroupAjaxLoadData( gallery, opts, items );
						}	
						
						$( gallery ).removeClass('loading');					
					} 
				});	
			}	

			$(window).load(function()
			{			
				group_gallery();		
			});			
	
		})(jQuery);